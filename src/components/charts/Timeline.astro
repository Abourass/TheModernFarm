---
/**
 * Timeline.astro
 * 
 * A horizontal or vertical process/step visualization for tutorials and fermentation phases.
 * Perfect for BIM culturing stages, fermentation timelines, or multi-step processes.
 * 
 * Usage in MDX:
 *   import Timeline from '../components/charts/Timeline.astro';
 *   
 *   <Timeline
 *     steps={[
 *       { title: 'BIM-1', duration: '5-7 days', description: 'Initial inoculation with rice wash' },
 *       { title: 'BIM-2', duration: '7 days', description: 'Milk fermentation stage' },
 *       { title: 'BIM-3', duration: '5 days', description: 'Molasses activation' },
 *       { title: 'BIM-4', duration: '7 days', description: 'Final maturation' }
 *     ]}
 *     title="BIM Culturing Process"
 *     category="fermentation"
 *   />
 * 
 * With status indicators:
 *   <Timeline
 *     steps={[
 *       { title: 'Day 0-3', description: 'Active fermentation', status: 'complete' },
 *       { title: 'Day 4-7', description: 'pH stabilizing', status: 'active' },
 *       { title: 'Day 8-14', description: 'Maturation', status: 'pending' }
 *     ]}
 *     orientation="vertical"
 *   />
 */

import type { TimelineProps, ChartCategory } from '../../types';

interface Props extends TimelineProps {}

const {
  steps,
  title,
  caption,
  orientation = 'horizontal',
  showDuration = true,
  category = 'default',
} = Astro.props;

// Category color schemes
const categoryAccents: Record<ChartCategory, string> = {
  'microbiology': '#8b5cf6',
  'plant-biology': '#16a34a',
  'fermentation': '#ea580c',
  'soil-science': '#78716c',
  'default': '#0d9488',
};

const accentColor = categoryAccents[category];

const chartId = `timeline-${Math.random().toString(36).substr(2, 9)}`;
---

<figure class={`timeline-container category-${category} ${orientation}`} role="figure" aria-labelledby={`${chartId}-title`}>
  {title && <figcaption id={`${chartId}-title`} class="timeline-title">{title}</figcaption>}
  
  <div class="timeline-wrapper">
    <div class="timeline-track">
      {steps.map((step, index) => (
        <div 
          class={`timeline-step ${step.status || 'pending'}`}
          data-step={index + 1}
        >
          <!-- Connector line (before) -->
          {index > 0 && (
            <div class="connector before" style={`background-color: ${step.status === 'complete' || step.status === 'active' ? accentColor : 'rgb(var(--gray-light))'};`} />
          )}
          
          <!-- Step node -->
          <div class="step-node" style={`
            background-color: ${step.status === 'complete' ? accentColor : step.status === 'active' ? 'white' : 'rgb(var(--gray-light))'};
            border-color: ${step.status === 'active' || step.status === 'complete' ? accentColor : 'rgb(var(--gray-light))'};
          `}>
            {step.status === 'complete' ? (
              <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                <polyline points="20 6 9 17 4 12" />
              </svg>
            ) : (
              <span class="step-number">{index + 1}</span>
            )}
          </div>
          
          <!-- Connector line (after) -->
          {index < steps.length - 1 && (
            <div class="connector after" style={`background-color: ${step.status === 'complete' ? accentColor : 'rgb(var(--gray-light))'};`} />
          )}
          
          <!-- Step content -->
          <div class="step-content">
            <span class="step-title">{step.title}</span>
            {showDuration && step.duration && (
              <span class="step-duration">{step.duration}</span>
            )}
            {step.description && (
              <span class="step-description">{step.description}</span>
            )}
          </div>
        </div>
      ))}
    </div>
  </div>
  
  {caption && <p class="timeline-caption">{caption}</p>}
</figure>

<style define:vars={{ accentColor }}>
  .timeline-container {
    background: white;
    border: 1px solid rgb(var(--gray-light));
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
  }

  :root.dark-theme .timeline-container {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.08);
  }

  .timeline-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgb(var(--black));
    margin: 0 0 1.5rem 0;
    text-align: center;
  }

  .timeline-wrapper {
    overflow-x: auto;
    padding: 1rem 0;
  }

  /* Horizontal orientation */
  .timeline-container.horizontal .timeline-track {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    min-width: max-content;
    gap: 0;
  }

  .timeline-container.horizontal .timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    min-width: 120px;
    position: relative;
  }

  .timeline-container.horizontal .connector {
    position: absolute;
    top: 16px;
    height: 3px;
    width: 50%;
  }

  .timeline-container.horizontal .connector.before {
    right: 50%;
    margin-right: 16px;
  }

  .timeline-container.horizontal .connector.after {
    left: 50%;
    margin-left: 16px;
  }

  .timeline-container.horizontal .step-content {
    margin-top: 1rem;
    text-align: center;
    max-width: 140px;
  }

  /* Vertical orientation */
  .timeline-container.vertical .timeline-track {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding-left: 2rem;
  }

  .timeline-container.vertical .timeline-step {
    display: flex;
    align-items: flex-start;
    position: relative;
    padding-bottom: 2rem;
  }

  .timeline-container.vertical .timeline-step:last-child {
    padding-bottom: 0;
  }

  .timeline-container.vertical .connector {
    position: absolute;
    left: 15px;
    width: 3px;
    height: 50%;
  }

  .timeline-container.vertical .connector.before {
    bottom: 50%;
    margin-bottom: 16px;
  }

  .timeline-container.vertical .connector.after {
    top: 50%;
    margin-top: 16px;
  }

  .timeline-container.vertical .step-content {
    margin-left: 1.25rem;
    text-align: left;
  }

  /* Step node */
  .step-node {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 3px solid;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .timeline-step:hover .step-node {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .step-number {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgb(var(--gray));
    font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', monospace;
  }

  .timeline-step.complete .step-number,
  .timeline-step.active .step-number {
    color: var(--accentColor);
  }

  :root.dark-theme .timeline-step.active .step-node {
    background-color: #1c1917 !important;
  }

  .check-icon {
    width: 16px;
    height: 16px;
  }

  /* Step content */
  .step-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .step-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgb(var(--black));
  }

  .step-duration {
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--accentColor);
    font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', monospace;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .step-description {
    font-size: 0.75rem;
    color: rgb(var(--gray));
    line-height: 1.4;
  }

  .timeline-caption {
    font-size: 0.75rem;
    color: rgb(var(--gray));
    text-align: center;
    margin: 1rem 0 0 0;
    font-style: italic;
  }

  /* Category-specific accent borders */
  .timeline-container.category-microbiology {
    border-left: 3px solid #8b5cf6;
  }

  .timeline-container.category-plant-biology {
    border-left: 3px solid #16a34a;
  }

  .timeline-container.category-fermentation {
    border-left: 3px solid #ea580c;
  }

  .timeline-container.category-soil-science {
    border-left: 3px solid #78716c;
  }

  .timeline-container.category-default {
    border-left: 3px solid var(--accent);
  }

  @media (max-width: 720px) {
    .timeline-container {
      padding: 1rem;
    }

    .timeline-container.horizontal .timeline-step {
      min-width: 100px;
    }

    .timeline-container.horizontal .step-content {
      max-width: 100px;
    }

    .step-node {
      width: 28px;
      height: 28px;
    }

    .step-title {
      font-size: 0.8rem;
    }

    .step-description {
      font-size: 0.7rem;
    }
  }
</style>
